"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const http = tslib_1.__importStar(require("http"));
module.exports = {
    name: "auth",
    afters: ["fix"],
    befores: ["directory", "static", "end"],
    _fromFile: true,
    body: async function body(req, res, event) {
        if (!event.carriage._global.patherr) {
            res.setHeader("X-Content-Type-Options", "nosniff");
            res.setHeader("X-XSS-Protection", "1; mode=block");
            res.setHeader("Cache-Control", "private, no-store, max-age=3600, must-revalidate");
            res.setHeader("X-Frame-Options", "sameorigin");
            if (!req.headers["authorization"]) {
                res.writeHead(401, http.STATUS_CODES[401], {
                    "WWW-Authenticate": 'Basic realm="Access to the staging site", charset="UTF-8"'
                });
                event.server._debug(event.reqcntr, "(AUTH.TS) 401");
            }
            else {
                let challenge = Buffer.from(req.headers["authorization"].split(' ')[1], "base64").toString();
                if (challenge === event.server.data["auth"]) {
                    event.server._debug(event.reqcntr, "(AUTH.TS) PASS");
                    return event.pass();
                }
                else {
                    res.writeHead(403, http.STATUS_CODES[403]);
                    event.server._debug(event.reqcntr, "(AUTH.TS) 403");
                }
            }
        }
        else {
            res.writeHead(400, http.STATUS_CODES[400], { "warning": "bad root" });
        }
        res.end("ERR");
        return event.stop();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9taWRkbGV3YXJlcy9hdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1EQUE2QjtBQUc3QixNQUFNLENBQUMsT0FBTyxHQUFHO0lBQ2hCLElBQUksRUFBRSxNQUFNO0lBQ1osTUFBTSxFQUFFLENBQUUsS0FBSyxDQUFFO0lBQ2pCLE9BQU8sRUFBRSxDQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFFO0lBQ3pDLFNBQVMsRUFBRSxJQUFJO0lBQ2YsSUFBSSxFQUFFLEtBQUssVUFBVSxJQUFJLENBQUMsR0FBeUIsRUFBRSxHQUF3QixFQUFFLEtBQXdCO1FBQ3RHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7WUFFcEMsR0FBRyxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNuRCxHQUFHLENBQUMsU0FBUyxDQUFDLGtCQUFrQixFQUFFLGVBQWUsQ0FBQyxDQUFDO1lBQ25ELEdBQUcsQ0FBQyxTQUFTLENBQUMsZUFBZSxFQUFFLGtEQUFrRCxDQUFDLENBQUM7WUFDbkYsR0FBRyxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUUvQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRTtnQkFDbEMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDMUMsa0JBQWtCLEVBQUUsMkRBQTJEO2lCQUMvRSxDQUFDLENBQUM7Z0JBRUgsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxlQUFlLENBQUMsQ0FBQzthQUNwRDtpQkFBTTtnQkFDTixJQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUU3RixJQUFJLFNBQVMsS0FBSyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDNUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO29CQUNyRCxPQUFPLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDcEI7cUJBQU07b0JBQ04sR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUMzQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLGVBQWUsQ0FBQyxDQUFDO2lCQUNwRDthQUNEO1NBQ0Q7YUFBTTtZQUNOLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztTQUN0RTtRQUVELEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDZixPQUFPLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNyQixDQUFDO0NBQ0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcclxuaW1wb3J0ICogYXMgdnNlcnYgZnJvbSBcInZhbGUtc2VydmVyLWlpXCI7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuXHRuYW1lOiBcImF1dGhcIixcclxuXHRhZnRlcnM6IFsgXCJmaXhcIiBdLFxyXG5cdGJlZm9yZXM6IFsgXCJkaXJlY3RvcnlcIiwgXCJzdGF0aWNcIiwgXCJlbmRcIiBdLFxyXG5cdF9mcm9tRmlsZTogdHJ1ZSxcclxuXHRib2R5OiBhc3luYyBmdW5jdGlvbiBib2R5KHJlcTogaHR0cC5JbmNvbWluZ01lc3NhZ2UsIHJlczogaHR0cC5TZXJ2ZXJSZXNwb25zZSwgZXZlbnQ6IHZzZXJ2LkNsYXNzZXMuZXZ0KTogUHJvbWlzZTxib29sZWFuPiB7XHJcblx0XHRpZiAoIWV2ZW50LmNhcnJpYWdlLl9nbG9iYWwucGF0aGVycikge1xyXG5cclxuXHRcdFx0cmVzLnNldEhlYWRlcihcIlgtQ29udGVudC1UeXBlLU9wdGlvbnNcIiwgXCJub3NuaWZmXCIpO1xyXG5cdFx0XHRyZXMuc2V0SGVhZGVyKFwiWC1YU1MtUHJvdGVjdGlvblwiLCBcIjE7IG1vZGU9YmxvY2tcIik7XHJcblx0XHRcdHJlcy5zZXRIZWFkZXIoXCJDYWNoZS1Db250cm9sXCIsIFwicHJpdmF0ZSwgbm8tc3RvcmUsIG1heC1hZ2U9MzYwMCwgbXVzdC1yZXZhbGlkYXRlXCIpO1xyXG5cdFx0XHRyZXMuc2V0SGVhZGVyKFwiWC1GcmFtZS1PcHRpb25zXCIsIFwic2FtZW9yaWdpblwiKTtcclxuXHJcblx0XHRcdGlmICghcmVxLmhlYWRlcnNbXCJhdXRob3JpemF0aW9uXCJdKSB7XHJcblx0XHRcdFx0cmVzLndyaXRlSGVhZCg0MDEsIGh0dHAuU1RBVFVTX0NPREVTWzQwMV0sIHtcclxuXHRcdFx0XHRcdFwiV1dXLUF1dGhlbnRpY2F0ZVwiOiAnQmFzaWMgcmVhbG09XCJBY2Nlc3MgdG8gdGhlIHN0YWdpbmcgc2l0ZVwiLCBjaGFyc2V0PVwiVVRGLThcIidcclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdFx0ZXZlbnQuc2VydmVyLl9kZWJ1ZyhldmVudC5yZXFjbnRyLCBcIihBVVRILlRTKSA0MDFcIik7XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0bGV0IGNoYWxsZW5nZSA9IEJ1ZmZlci5mcm9tKHJlcS5oZWFkZXJzW1wiYXV0aG9yaXphdGlvblwiXS5zcGxpdCgnICcpWzFdLCBcImJhc2U2NFwiKS50b1N0cmluZygpO1xyXG5cclxuXHRcdFx0XHRpZiAoY2hhbGxlbmdlID09PSBldmVudC5zZXJ2ZXIuZGF0YVtcImF1dGhcIl0pIHtcclxuXHRcdFx0XHRcdGV2ZW50LnNlcnZlci5fZGVidWcoZXZlbnQucmVxY250ciwgXCIoQVVUSC5UUykgUEFTU1wiKTtcclxuXHRcdFx0XHRcdHJldHVybiBldmVudC5wYXNzKCk7XHJcblx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdHJlcy53cml0ZUhlYWQoNDAzLCBodHRwLlNUQVRVU19DT0RFU1s0MDNdKTtcclxuXHRcdFx0XHRcdGV2ZW50LnNlcnZlci5fZGVidWcoZXZlbnQucmVxY250ciwgXCIoQVVUSC5UUykgNDAzXCIpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fVxyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0cmVzLndyaXRlSGVhZCg0MDAsIGh0dHAuU1RBVFVTX0NPREVTWzQwMF0sIHsgXCJ3YXJuaW5nXCI6IFwiYmFkIHJvb3RcIiB9KTtcclxuXHRcdH1cclxuXHJcblx0XHRyZXMuZW5kKFwiRVJSXCIpO1xyXG5cdFx0cmV0dXJuIGV2ZW50LnN0b3AoKTtcclxuXHR9XHJcbn07XHJcbiJdfQ==