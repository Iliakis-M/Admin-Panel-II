"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const fs = tslib_1.__importStar(require("fs-extra"));
const path = tslib_1.__importStar(require("path"));
const os = tslib_1.__importStar(require("os"));
var Socket;
(function (Socket) {
    function setup(io, panel) {
        let admin = io.of("/admin"), login = false, ladm;
        panel.on("_debug", (...data) => {
            if (ladm)
                ladm.emit("_debug", ...data);
        });
        panel.serv.on("_debug", (...data) => {
            if (ladm)
                ladm.emit("_s_debug", ...data);
        });
        if (panel.refresh) {
            let ends = new Set([
                ".htm",
                ".html",
                ".htmx",
                ".htmlx",
                ".js",
                ".xjs",
                ".css",
                ".cssx"
            ]);
            fs.watch(path.join(panel.serv.opts.serveDir, panel.serv.opts.public), {
                recursive: true
            }, (evt, file) => {
                if (panel.refresh && Array.from(ends.values()).some(end => file.endsWith(end))) {
                    panel._debug("Refreshing...");
                    admin.emit("refresh");
                }
            });
        }
        admin.on("connect", async (socket) => {
            panel._debug(socket.id + " connected.");
            socket.once("disconnecting", async (reason) => {
                panel._debug(socket.id + " disconnecting  " + reason);
                login = false;
            });
            if (!login) {
                socket.join("admin", async (err) => {
                    if (!err) {
                        socket.emit("joined", "admin");
                        panel._debug(`${socket.id} is admin.`);
                        login = true;
                        ladm = socket;
                        socket.emit("stat", "arch", os.arch());
                        socket.emit("stat", "cpus", os.cpus().length);
                        socket.emit("stat", "endian", os.endianness());
                        socket.emit("stat", "platform", os.platform());
                        socket.emit("stat", "release", os.release());
                        socket.emit("stat", "type", os.type());
                        let prev1 = process.cpuUsage();
                        async function tick() {
                            let mem = process.memoryUsage();
                            prev1 = process.cpuUsage(prev1);
                            socket.emit("stat", "freemem", Math.round((os.freemem() / 1024 / 1024 / 1024) * 100) / 100);
                            socket.emit("stat", "totalmem", Math.round((os.totalmem() / 1024 / 1024 / 1024) * 100) / 100);
                            socket.emit("stat", "priority", os.getPriority());
                            socket.emit("stat", "home", os.homedir());
                            socket.emit("stat", "host", os.hostname());
                            socket.emit("stat", "tmp", os.tmpdir());
                            socket.emit("stat", "up", Math.round(os.uptime() / 60 * 10) / 10);
                            socket.emit("stat", "pup", Math.round(process.uptime() / 60 * 10) / 10);
                            socket.emit("stat", "cpuus", process.cpuUsage().user / 1000);
                            socket.emit("stat", "cpuusp", prev1.user / 1000);
                            socket.emit("stat", "cpusy", process.cpuUsage().system / 1000);
                            socket.emit("stat", "cpusyp", prev1.system / 1000);
                            socket.emit("stat", "cwd", process.cwd());
                            socket.emit("stat", "rss", Math.round(mem.rss / 1024 / 1024 * 100) / 100);
                            socket.emit("stat", "total1", Math.round(mem.heapTotal / 1024 / 1024 * 100) / 100);
                            socket.emit("stat", "used1", Math.round(mem.heapUsed / 1024 / 1024 * 100) / 100);
                            socket.emit("stat", "ext", Math.round(mem.external / 1024 / 1024 * 100) / 100);
                            return tick;
                        } //tick
                        setInterval(await tick(), panel.custping);
                    }
                });
                socket.on("error", async (err) => {
                    panel._debug(err);
                });
                socket.on("command", async (name, ...params) => {
                    params = params.map(param => param === "$panel$" ? panel : param);
                    panel._debug(`Command:  ${name} ${params.slice(0, params.length - 1).join(' ')}  -->`);
                    let out = await panel.cmds.find(cmd => cmd.name === name).body(...params);
                    panel._debug(`  ${out}`);
                    params[params.length - 1](out);
                });
                socket.on("cli", async (comm) => panel.rl.write(comm + os.EOL));
            }
            else {
                socket.disconnect(true);
            }
        });
        return admin;
    } //setup
    Socket.setup = setup;
})(Socket = exports.Socket || (exports.Socket = {})); //Socket
exports.default = Socket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3NvY2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUdiLHFEQUErQjtBQUMvQixtREFBNkI7QUFDN0IsK0NBQXlCO0FBRXpCLElBQWMsTUFBTSxDQXdHbkI7QUF4R0QsV0FBYyxNQUFNO0lBRW5CLFNBQWdCLEtBQUssQ0FBQyxFQUFtQixFQUFFLEtBQW9CO1FBQzlELElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQzFCLEtBQUssR0FBWSxLQUFLLEVBQ3RCLElBQXFCLENBQUM7UUFFdkIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxHQUFHLElBQVcsRUFBRSxFQUFFO1lBQ3JDLElBQUksSUFBSTtnQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBRyxJQUFXLEVBQUUsRUFBRTtZQUMxQyxJQUFJLElBQUk7Z0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUNsQixJQUFJLElBQUksR0FBZ0IsSUFBSSxHQUFHLENBQUM7Z0JBQy9CLE1BQU07Z0JBQ04sT0FBTztnQkFDUCxPQUFPO2dCQUNQLFFBQVE7Z0JBQ1IsS0FBSztnQkFDTCxNQUFNO2dCQUNOLE1BQU07Z0JBQ04sT0FBTzthQUNQLENBQUMsQ0FBQztZQUVILEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUs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QUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQzs0QkFDOUYsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDOzRCQUNsRCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7NEJBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQzs0QkFDM0MsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDOzRCQUN4QyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDOzRCQUNsRSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDOzRCQUN4RSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQzs0QkFDN0QsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUM7NEJBQ2pELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDOzRCQUMvRCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQzs0QkFDbkQsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDOzRCQUMxQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7NEJBQzFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQzs0QkFDbkYsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDOzRCQUNqRixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7NEJBQy9FLE9BQU8sSUFBSSxDQUFDO3dCQUNiLENBQUMsQ0FBQyxNQUFNO3dCQUVSLFdBQVcsQ0FBQyxNQUFNLElBQUksRUFBRSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztxQkFDMUM7Z0JBQ0YsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFDLEdBQUcsRUFBQyxFQUFFO29CQUM5QixLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNuQixDQUFDLENBQUMsQ0FBQztnQkFDSCxNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxFQUFFLEVBQUU7b0JBQzlDLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDbEUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFhLElBQUksSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ3ZGLElBQUksR0FBRyxHQUFHLE1BQU0sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO29CQUMxRSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDekIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2hDLENBQUMsQ0FBQyxDQUFDO2dCQUNILE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBQyxJQUFJLEVBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUM5RDtpQkFBTTtnQkFDTixNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3hCO1FBQ0YsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEtBQUssQ0FBQztJQUNkLENBQUMsQ0FBQyxPQUFPO0lBcEdPLFlBQUssUUFvR3BCLENBQUE7QUFFRixDQUFDLEVBeEdhLE1BQU0sR0FBTixjQUFNLEtBQU4sY0FBTSxRQXdHbkIsQ0FBQyxRQUFRO0FBRVYsa0JBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG5pbXBvcnQgQ2xhc3NlcyBmcm9tICcuL0NsYXNzZXMnO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xyXG5pbXBvcnQgKiBhcyBvcyBmcm9tIFwib3NcIjtcclxuXHJcbmV4cG9ydCBtb2R1bGUgU29ja2V0IHtcclxuXHJcblx0ZXhwb3J0IGZ1bmN0aW9uIHNldHVwKGlvOiBTb2NrZXRJTy5TZXJ2ZXIsIHBhbmVsOiBDbGFzc2VzLlBhbmVsKSB7XHJcblx0XHRsZXQgYWRtaW4gPSBpby5vZihcIi9hZG1pblwiKSxcclxuXHRcdFx0bG9naW46IGJvb2xlYW4gPSBmYWxzZSxcclxuXHRcdFx0bGFkbTogU29ja2V0SU8uU29ja2V0O1xyXG5cclxuXHRcdHBhbmVsLm9uKFwiX2RlYnVnXCIsICguLi5kYXRhOiBhbnlbXSkgPT4ge1xyXG5cdFx0XHRpZiAobGFkbSkgbGFkbS5lbWl0KFwiX2RlYnVnXCIsIC4uLmRhdGEpO1xyXG5cdFx0fSk7XHJcblx0XHRwYW5lbC5zZXJ2Lm9uKFwiX2RlYnVnXCIsICguLi5kYXRhOiBhbnlbXSkgPT4ge1xyXG5cdFx0XHRpZiAobGFkbSkgbGFkbS5lbWl0KFwiX3NfZGVidWdcIiwgLi4uZGF0YSk7XHJcblx0XHR9KTtcclxuXHRcdGlmIChwYW5lbC5yZWZyZXNoKSB7XHJcblx0XHRcdGxldCBlbmRzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoW1xyXG5cdFx0XHRcdFwiLmh0bVwiLFxyXG5cdFx0XHRcdFwiLmh0bWxcIixcclxuXHRcdFx0XHRcIi5odG14XCIsXHJcblx0XHRcdFx0XCIuaHRtbHhcIixcclxuXHRcdFx0XHRcIi5qc1wiLFxyXG5cdFx0XHRcdFwiLnhqc1wiLFxyXG5cdFx0XHRcdFwiLmNzc1wiLFxyXG5cdFx0XHRcdFwiLmNzc3hcIlxyXG5cdFx0XHRdKTtcclxuXHJcblx0XHRcdGZzLndhdGNoKHBhdGguam9pbihwYW5lbC5zZXJ2Lm9wdHMuc2VydmVEaXIsIHBhbmVsLnNlcnYub3B0cy5wdWJsaWMpLCB7XHJcblx0XHRcdFx0cmVjdXJzaXZlOiB0cnVlXHJcblx0XHRcdH0sIChldnQsIGZpbGUpID0+IHtcclxuXHRcdFx0XHRcdGlmIChwYW5lbC5yZWZyZXNoICYmIEFycmF5LmZyb20oZW5kcy52YWx1ZXMoKSkuc29tZShlbmQgPT4gZmlsZS5lbmRzV2l0aChlbmQpKSkge1xyXG5cdFx0XHRcdFx0XHRwYW5lbC5fZGVidWcoXCJSZWZyZXNoaW5nLi4uXCIpO1xyXG5cdFx0XHRcdFx0XHRhZG1pbi5lbWl0KFwicmVmcmVzaFwiKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblx0XHRcclxuXHRcdGFkbWluLm9uKFwiY29ubmVjdFwiLCBhc3luYyBzb2NrZXQgPT4ge1xyXG5cdFx0XHRwYW5lbC5fZGVidWcoc29ja2V0LmlkICsgXCIgY29ubmVjdGVkLlwiKTtcclxuXHRcdFx0c29ja2V0Lm9uY2UoXCJkaXNjb25uZWN0aW5nXCIsIGFzeW5jIHJlYXNvbiA9PiB7XHJcblx0XHRcdFx0cGFuZWwuX2RlYnVnKHNvY2tldC5pZCArIFwiIGRpc2Nvbm5lY3RpbmcgIFwiICsgcmVhc29uKTtcclxuXHRcdFx0XHRsb2dpbiA9IGZhbHNlO1xyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdGlmICghbG9naW4pIHtcclxuXHRcdFx0XHRzb2NrZXQuam9pbihcImFkbWluXCIsIGFzeW5jIGVyciA9PiB7XHJcblx0XHRcdFx0XHRpZiAoIWVycikge1xyXG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcImpvaW5lZFwiLCBcImFkbWluXCIpO1xyXG5cdFx0XHRcdFx0XHRwYW5lbC5fZGVidWcoYCR7c29ja2V0LmlkfSBpcyBhZG1pbi5gKTtcclxuXHRcdFx0XHRcdFx0bG9naW4gPSB0cnVlO1xyXG5cdFx0XHRcdFx0XHRsYWRtID0gc29ja2V0O1xyXG5cclxuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiYXJjaFwiLCBvcy5hcmNoKCkpO1xyXG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJjcHVzXCIsIG9zLmNwdXMoKS5sZW5ndGgpO1xyXG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJlbmRpYW5cIiwgb3MuZW5kaWFubmVzcygpKTtcclxuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwicGxhdGZvcm1cIiwgb3MucGxhdGZvcm0oKSk7XHJcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInJlbGVhc2VcIiwgb3MucmVsZWFzZSgpKTtcclxuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwidHlwZVwiLCBvcy50eXBlKCkpO1xyXG5cclxuXHRcdFx0XHRcdFx0bGV0IHByZXYxID0gcHJvY2Vzcy5jcHVVc2FnZSgpO1xyXG5cclxuXHRcdFx0XHRcdFx0YXN5bmMgZnVuY3Rpb24gdGljaygpIHtcclxuXHRcdFx0XHRcdFx0XHRsZXQgbWVtID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xyXG5cdFx0XHRcdFx0XHRcdHByZXYxID0gcHJvY2Vzcy5jcHVVc2FnZShwcmV2MSk7XHJcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiZnJlZW1lbVwiLCBNYXRoLnJvdW5kKChvcy5mcmVlbWVtKCkgLyAxMDI0IC8gMTAyNCAvIDEwMjQpICogMTAwKSAvIDEwMCk7XHJcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwidG90YWxtZW1cIiwgTWF0aC5yb3VuZCgob3MudG90YWxtZW0oKSAvIDEwMjQgLyAxMDI0IC8gMTAyNCkgKiAxMDApIC8gMTAwKTtcclxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJwcmlvcml0eVwiLCBvcy5nZXRQcmlvcml0eSgpKTtcclxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJob21lXCIsIG9zLmhvbWVkaXIoKSk7XHJcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiaG9zdFwiLCBvcy5ob3N0bmFtZSgpKTtcclxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ0bXBcIiwgb3MudG1wZGlyKCkpO1xyXG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInVwXCIsIE1hdGgucm91bmQob3MudXB0aW1lKCkgLyA2MCAqIDEwKSAvIDEwKTtcclxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJwdXBcIiwgTWF0aC5yb3VuZChwcm9jZXNzLnVwdGltZSgpIC8gNjAgKiAxMCkgLyAxMCk7XHJcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiY3B1dXNcIiwgcHJvY2Vzcy5jcHVVc2FnZSgpLnVzZXIgLyAxMDAwKTtcclxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJjcHV1c3BcIiwgcHJldjEudXNlciAvIDEwMDApO1xyXG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImNwdXN5XCIsIHByb2Nlc3MuY3B1VXNhZ2UoKS5zeXN0ZW0gLyAxMDAwKTtcclxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJjcHVzeXBcIiwgcHJldjEuc3lzdGVtIC8gMTAwMCk7XHJcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiY3dkXCIsIHByb2Nlc3MuY3dkKCkpO1xyXG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInJzc1wiLCBNYXRoLnJvdW5kKG1lbS5yc3MgLyAxMDI0IC8gMTAyNCAqIDEwMCkgLyAxMDApO1xyXG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInRvdGFsMVwiLCBNYXRoLnJvdW5kKG1lbS5oZWFwVG90YWwgLyAxMDI0IC8gMTAyNCAqIDEwMCkgLyAxMDApO1xyXG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInVzZWQxXCIsIE1hdGgucm91bmQobWVtLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQgKiAxMDApIC8gMTAwKTtcclxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJleHRcIiwgTWF0aC5yb3VuZChtZW0uZXh0ZXJuYWwgLyAxMDI0IC8gMTAyNCAqIDEwMCkgLyAxMDApO1xyXG5cdFx0XHRcdFx0XHRcdHJldHVybiB0aWNrO1xyXG5cdFx0XHRcdFx0XHR9IC8vdGlja1xyXG5cclxuXHRcdFx0XHRcdFx0c2V0SW50ZXJ2YWwoYXdhaXQgdGljaygpLCBwYW5lbC5jdXN0cGluZyk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdFx0c29ja2V0Lm9uKFwiZXJyb3JcIiwgYXN5bmMgZXJyID0+IHtcclxuXHRcdFx0XHRcdHBhbmVsLl9kZWJ1ZyhlcnIpO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHRcdHNvY2tldC5vbihcImNvbW1hbmRcIiwgYXN5bmMgKG5hbWUsIC4uLnBhcmFtcykgPT4ge1xyXG5cdFx0XHRcdFx0cGFyYW1zID0gcGFyYW1zLm1hcChwYXJhbSA9PiBwYXJhbSA9PT0gXCIkcGFuZWwkXCIgPyBwYW5lbCA6IHBhcmFtKTtcclxuXHRcdFx0XHRcdHBhbmVsLl9kZWJ1ZyhgQ29tbWFuZDogICR7bmFtZX0gJHtwYXJhbXMuc2xpY2UoMCwgcGFyYW1zLmxlbmd0aCAtIDEpLmpvaW4oJyAnKX0gIC0tPmApO1xyXG5cdFx0XHRcdFx0bGV0IG91dCA9IGF3YWl0IHBhbmVsLmNtZHMuZmluZChjbWQgPT4gY21kLm5hbWUgPT09IG5hbWUpLmJvZHkoLi4ucGFyYW1zKTtcclxuXHRcdFx0XHRcdHBhbmVsLl9kZWJ1ZyhgICAke291dH1gKTtcclxuXHRcdFx0XHRcdHBhcmFtc1twYXJhbXMubGVuZ3RoIC0gMV0ob3V0KTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0XHRzb2NrZXQub24oXCJjbGlcIiwgYXN5bmMgY29tbSA9PiBwYW5lbC5ybC53cml0ZShjb21tICsgb3MuRU9MKSk7XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0c29ja2V0LmRpc2Nvbm5lY3QodHJ1ZSk7XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cclxuXHRcdHJldHVybiBhZG1pbjtcclxuXHR9IC8vc2V0dXBcclxuXHJcbn0gLy9Tb2NrZXRcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFNvY2tldDtcclxuIl19