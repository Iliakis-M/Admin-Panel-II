"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const fs = tslib_1.__importStar(require("fs-extra"));
const path = tslib_1.__importStar(require("path"));
const os = tslib_1.__importStar(require("os"));
var Socket;
(function (Socket) {
    /**
     * Wrapper for setting up the Socket.
     *
     * @author V. H.
     * @date 2019-05-12
     * @export
     * @param {SocketIO.Server} io
     * @param {Classes.Panel} panel
     * @returns {SocketIO.Namespace}
     */
    function setup(io, panel) {
        let admin = io.of("/admin"), login = false, ladm;
        panel.on("_debug", async (...data) => {
            if (ladm)
                ladm.emit("_debug", ...data);
        });
        panel.serv.on("_debug", async (...data) => {
            if (ladm)
                ladm.emit("_s_debug", ...data);
        });
        panel.stater.on("snap", async (reg) => {
            if (ladm)
                ladm.emit("snap", reg);
        });
        if (panel.refresh) {
            let ends = new Set([
                ".htm",
                ".html",
                ".htmx",
                ".htmlx",
                ".js",
                ".xjs",
                ".css",
                ".cssx"
            ]);
            fs.watch(path.join(panel.serv.opts.serveDir, panel.serv.opts.public), {
                recursive: true
            }, (evt, file) => {
                if (panel.refresh && Array.from(ends.values()).some(end => file.endsWith(end))) {
                    panel._debug("Refreshing...");
                    admin.emit("refresh");
                }
            });
        }
        admin.on("connect", async (socket) => {
            panel._debug(socket.id + " connected.");
            socket.once("disconnecting", async (reason) => {
                panel._debug(socket.id + " disconnecting  " + reason);
                login = false;
            });
            if (!login) {
                socket.join("admin", async (err) => {
                    if (!err) {
                        socket.emit("_debug", panel._debuglog);
                        socket.emit("_s_debug", panel.serv._debuglog);
                        socket.emit("cli", panel._rllog);
                        for (let snap of panel.stater.samples) {
                            socket.emit("snap", snap);
                        }
                        socket.emit("joined", "admin");
                        panel._debug(`${socket.id} is admin.`);
                        login = true;
                        ladm = socket;
                        socket.emit("stat", "arch", os.arch());
                        socket.emit("stat", "cpus", os.cpus().length);
                        socket.emit("stat", "endian", os.endianness());
                        socket.emit("stat", "platform", os.platform());
                        socket.emit("stat", "release", os.release());
                        socket.emit("stat", "type", os.type());
                        socket.emit("stat", "version", process.version);
                        let prev1 = process.cpuUsage();
                        async function tick() {
                            let mem = process.memoryUsage();
                            prev1 = process.cpuUsage(prev1);
                            socket.emit("stat", "freemem", Math.round((os.freemem() / 1024 / 1024 / 1024) * 100) / 100);
                            socket.emit("stat", "totalmem", Math.round((os.totalmem() / 1024 / 1024 / 1024) * 100) / 100);
                            socket.emit("stat", "priority", os.getPriority());
                            socket.emit("stat", "home", os.homedir());
                            socket.emit("stat", "host", os.hostname());
                            socket.emit("stat", "tmp", os.tmpdir());
                            socket.emit("stat", "up", Math.round(os.uptime() / 6) / 10);
                            socket.emit("stat", "pup", Math.round(process.uptime() / 6) / 10);
                            socket.emit("stat", "cpuus", process.cpuUsage().user / 1000); //micro -> milli
                            socket.emit("stat", "cpuusp", prev1.user / 1000);
                            socket.emit("stat", "cpusy", process.cpuUsage().system / 1000);
                            socket.emit("stat", "cpusyp", prev1.system / 1000);
                            socket.emit("stat", "cwd", process.cwd());
                            socket.emit("stat", "rss", Math.round(100 * mem.rss / 1024 / 1024) / 100);
                            socket.emit("stat", "total1", Math.round(100 * mem.heapTotal / 1024 / 1024) / 100);
                            socket.emit("stat", "used1", Math.round(100 * mem.heapUsed / 1024 / 1024) / 100);
                            socket.emit("stat", "ext", Math.round(100 * mem.external / 1024 / 1024) / 100);
                            socket.emit("stat", "title", process.title);
                            socket.emit("stat", "port", process.debugPort);
                            return tick;
                        } //tick
                        setInterval(await tick(), panel.custping);
                    }
                });
                socket.on("error", async (err) => {
                    panel._debug(err);
                });
                socket.on("command", async (name, ...params) => {
                    params = params.map(param => param === "$panel$" ? panel : param);
                    panel._debug(`Command:  ${name} ${params.slice(0, params.length - 1).join(' ')}  -->`);
                    let out = await panel.cmds.find(cmd => cmd.name === name).body(...params);
                    panel._debug(`  ${out}`);
                    params[params.length - 1](out);
                });
                socket.on("cli", async (comm) => panel.rl.write(comm + os.EOL));
            }
            else {
                socket.disconnect(true);
            }
        });
        return admin;
    } //setup
    Socket.setup = setup;
})(Socket = exports.Socket || (exports.Socket = {})); //Socket
exports.default = Socket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3NvY2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUdiLHFEQUErQjtBQUMvQixtREFBNkI7QUFDN0IsK0NBQXlCO0FBRXpCLElBQWMsTUFBTSxDQWdJbkI7QUFoSUQsV0FBYyxNQUFNO0lBRW5COzs7Ozs7Ozs7T0FTRztJQUNILFNBQWdCLEtBQUssQ0FBQyxFQUFtQixFQUFFLEtBQW9CO1FBQzlELElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQzFCLEtBQUssR0FBWSxLQUFLLEVBQ3RCLElBQXFCLENBQUM7UUFFdkIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBVyxFQUFFLEVBQUU7WUFDM0MsSUFBSSxJQUFJO2dCQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBVyxFQUFFLEVBQUU7WUFDaEQsSUFBSSxJQUFJO2dCQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFDLEdBQUcsRUFBQyxFQUFFO1lBQ25DLElBQUksSUFBSTtnQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUNsQixJQUFJLElBQUksR0FBZ0IsSUFBSSxHQUFHLENBQUM7Z0JB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TSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzt3QkFDN0MsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO3dCQUN2QyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUVoRCxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7d0JBRS9CLEtBQUssVUFBVSxJQUFJOzRCQUNsQixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7NEJBQ2hDLEtBQUssR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDOzRCQUVoQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDOzRCQUM1RixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDOzRCQUM5RixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7NEJBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzs0QkFDMUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxR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a0JBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBDbGFzc2VzIGZyb20gJy4vQ2xhc3Nlcyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIG9zIGZyb20gXCJvc1wiO1xuXG5leHBvcnQgbW9kdWxlIFNvY2tldCB7XG5cblx0LyoqXG5cdCAqIFdyYXBwZXIgZm9yIHNldHRpbmcgdXAgdGhlIFNvY2tldC5cblx0ICogXG5cdCAqIEBhdXRob3IgVi4gSC5cblx0ICogQGRhdGUgMjAxOS0wNS0xMlxuXHQgKiBAZXhwb3J0XG5cdCAqIEBwYXJhbSB7U29ja2V0SU8uU2VydmVyfSBpb1xuXHQgKiBAcGFyYW0ge0NsYXNzZXMuUGFuZWx9IHBhbmVsXG5cdCAqIEByZXR1cm5zIHtTb2NrZXRJTy5OYW1lc3BhY2V9XG5cdCAqL1xuXHRleHBvcnQgZnVuY3Rpb24gc2V0dXAoaW86IFNvY2tldElPLlNlcnZlciwgcGFuZWw6IENsYXNzZXMuUGFuZWwpIHtcblx0XHRsZXQgYWRtaW4gPSBpby5vZihcIi9hZG1pblwiKSxcblx0XHRcdGxvZ2luOiBib29sZWFuID0gZmFsc2UsXG5cdFx0XHRsYWRtOiBTb2NrZXRJTy5Tb2NrZXQ7XG5cblx0XHRwYW5lbC5vbihcIl9kZWJ1Z1wiLCBhc3luYyAoLi4uZGF0YTogYW55W10pID0+IHtcblx0XHRcdGlmIChsYWRtKSBsYWRtLmVtaXQoXCJfZGVidWdcIiwgLi4uZGF0YSk7XG5cdFx0fSk7XG5cdFx0cGFuZWwuc2Vydi5vbihcIl9kZWJ1Z1wiLCBhc3luYyAoLi4uZGF0YTogYW55W10pID0+IHtcblx0XHRcdGlmIChsYWRtKSBsYWRtLmVtaXQoXCJfc19kZWJ1Z1wiLCAuLi5kYXRhKTtcblx0XHR9KTtcblx0XHRwYW5lbC5zdGF0ZXIub24oXCJzbmFwXCIsIGFzeW5jIHJlZyA9PiB7XG5cdFx0XHRpZiAobGFkbSkgbGFkbS5lbWl0KFwic25hcFwiLCByZWcpO1xuXHRcdH0pO1xuXHRcdGlmIChwYW5lbC5yZWZyZXNoKSB7XG5cdFx0XHRsZXQgZW5kczogU2V0PHN0cmluZz4gPSBuZXcgU2V0KFtcblx0XHRcdFx0XCIuaHRtXCIsXG5cdFx0XHRcdFwiLmh0bWxcIixcblx0XHRcdFx0XCIuaHRteFwiLFxuXHRcdFx0XHRcIi5odG1seFwiLFxuXHRcdFx0XHRcIi5qc1wiLFxuXHRcdFx0XHRcIi54anNcIixcblx0XHRcdFx0XCIuY3NzXCIsXG5cdFx0XHRcdFwiLmNzc3hcIlxuXHRcdFx0XSk7XG5cblx0XHRcdGZzLndhdGNoKHBhdGguam9pbihwYW5lbC5zZXJ2Lm9wdHMuc2VydmVEaXIsIHBhbmVsLnNlcnYub3B0cy5wdWJsaWMpLCB7XG5cdFx0XHRcdHJlY3Vyc2l2ZTogdHJ1ZVxuXHRcdFx0fSwgKGV2dCwgZmlsZSkgPT4ge1xuXHRcdFx0XHRcdGlmIChwYW5lbC5yZWZyZXNoICYmIEFycmF5LmZyb20oZW5kcy52YWx1ZXMoKSkuc29tZShlbmQgPT4gZmlsZS5lbmRzV2l0aChlbmQpKSkge1xuXHRcdFx0XHRcdFx0cGFuZWwuX2RlYnVnKFwiUmVmcmVzaGluZy4uLlwiKTtcblx0XHRcdFx0XHRcdGFkbWluLmVtaXQoXCJyZWZyZXNoXCIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH1cblx0XHRcblx0XHRhZG1pbi5vbihcImNvbm5lY3RcIiwgYXN5bmMgc29ja2V0ID0+IHtcblx0XHRcdHBhbmVsLl9kZWJ1Zyhzb2NrZXQuaWQgKyBcIiBjb25uZWN0ZWQuXCIpO1xuXHRcdFx0c29ja2V0Lm9uY2UoXCJkaXNjb25uZWN0aW5nXCIsIGFzeW5jIHJlYXNvbiA9PiB7XG5cdFx0XHRcdHBhbmVsLl9kZWJ1Zyhzb2NrZXQuaWQgKyBcIiBkaXNjb25uZWN0aW5nICBcIiArIHJlYXNvbik7XG5cdFx0XHRcdGxvZ2luID0gZmFsc2U7XG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKCFsb2dpbikge1xuXHRcdFx0XHRzb2NrZXQuam9pbihcImFkbWluXCIsIGFzeW5jIGVyciA9PiB7XG5cdFx0XHRcdFx0aWYgKCFlcnIpIHtcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwiX2RlYnVnXCIsIHBhbmVsLl9kZWJ1Z2xvZyk7XG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcIl9zX2RlYnVnXCIsIHBhbmVsLnNlcnYuX2RlYnVnbG9nKTtcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwiY2xpXCIsIHBhbmVsLl9ybGxvZyk7XG5cdFx0XHRcdFx0XHRmb3IgKGxldCBzbmFwIG9mIHBhbmVsLnN0YXRlci5zYW1wbGVzKSB7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic25hcFwiLCBzbmFwKTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJqb2luZWRcIiwgXCJhZG1pblwiKTtcblx0XHRcdFx0XHRcdHBhbmVsLl9kZWJ1ZyhgJHtzb2NrZXQuaWR9IGlzIGFkbWluLmApO1xuXHRcdFx0XHRcdFx0bG9naW4gPSB0cnVlO1xuXHRcdFx0XHRcdFx0bGFkbSA9IHNvY2tldDtcblxuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiYXJjaFwiLCBvcy5hcmNoKCkpO1xuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiY3B1c1wiLCBvcy5jcHVzKCkubGVuZ3RoKTtcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImVuZGlhblwiLCBvcy5lbmRpYW5uZXNzKCkpO1xuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwicGxhdGZvcm1cIiwgb3MucGxhdGZvcm0oKSk7XG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJyZWxlYXNlXCIsIG9zLnJlbGVhc2UoKSk7XG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ0eXBlXCIsIG9zLnR5cGUoKSk7XG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ2ZXJzaW9uXCIsIHByb2Nlc3MudmVyc2lvbik7XG5cblx0XHRcdFx0XHRcdGxldCBwcmV2MSA9IHByb2Nlc3MuY3B1VXNhZ2UoKTtcblxuXHRcdFx0XHRcdFx0YXN5bmMgZnVuY3Rpb24gdGljaygpIHtcblx0XHRcdFx0XHRcdFx0bGV0IG1lbSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcblx0XHRcdFx0XHRcdFx0cHJldjEgPSBwcm9jZXNzLmNwdVVzYWdlKHByZXYxKTtcblxuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJmcmVlbWVtXCIsIE1hdGgucm91bmQoKG9zLmZyZWVtZW0oKSAvIDEwMjQgLyAxMDI0IC8gMTAyNCkgKiAxMDApIC8gMTAwKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwidG90YWxtZW1cIiwgTWF0aC5yb3VuZCgob3MudG90YWxtZW0oKSAvIDEwMjQgLyAxMDI0IC8gMTAyNCkgKiAxMDApIC8gMTAwKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwicHJpb3JpdHlcIiwgb3MuZ2V0UHJpb3JpdHkoKSk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImhvbWVcIiwgb3MuaG9tZWRpcigpKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiaG9zdFwiLCBvcy5ob3N0bmFtZSgpKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwidG1wXCIsIG9zLnRtcGRpcigpKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwidXBcIiwgTWF0aC5yb3VuZChvcy51cHRpbWUoKSAvIDYpIC8gMTApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJwdXBcIiwgTWF0aC5yb3VuZChwcm9jZXNzLnVwdGltZSgpIC8gNikgLyAxMCk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImNwdXVzXCIsIHByb2Nlc3MuY3B1VXNhZ2UoKS51c2VyIC8gMTAwMCk7ICAvL21pY3JvIC0+IG1pbGxpXG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImNwdXVzcFwiLCBwcmV2MS51c2VyIC8gMTAwMCk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImNwdXN5XCIsIHByb2Nlc3MuY3B1VXNhZ2UoKS5zeXN0ZW0gLyAxMDAwKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiY3B1c3lwXCIsIHByZXYxLnN5c3RlbSAvIDEwMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJjd2RcIiwgcHJvY2Vzcy5jd2QoKSk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInJzc1wiLCBNYXRoLnJvdW5kKDEwMCAqIG1lbS5yc3MgLyAxMDI0IC8gMTAyNCkgLyAxMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ0b3RhbDFcIiwgTWF0aC5yb3VuZCgxMDAgKiBtZW0uaGVhcFRvdGFsIC8gMTAyNCAvIDEwMjQpIC8gMTAwKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwidXNlZDFcIiwgTWF0aC5yb3VuZCgxMDAgKiBtZW0uaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCkgLyAxMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJleHRcIiwgTWF0aC5yb3VuZCgxMDAgKiBtZW0uZXh0ZXJuYWwgLyAxMDI0IC8gMTAyNCkgLyAxMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ0aXRsZVwiLCBwcm9jZXNzLnRpdGxlKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwicG9ydFwiLCBwcm9jZXNzLmRlYnVnUG9ydCk7XG5cdFx0XHRcdFx0XHRcdHJldHVybiB0aWNrO1xuXHRcdFx0XHRcdFx0fSAvL3RpY2tcblxuXHRcdFx0XHRcdFx0c2V0SW50ZXJ2YWwoYXdhaXQgdGljaygpLCBwYW5lbC5jdXN0cGluZyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHRcdFx0c29ja2V0Lm9uKFwiZXJyb3JcIiwgYXN5bmMgZXJyID0+IHtcblx0XHRcdFx0XHRwYW5lbC5fZGVidWcoZXJyKTtcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHNvY2tldC5vbihcImNvbW1hbmRcIiwgYXN5bmMgKG5hbWUsIC4uLnBhcmFtcykgPT4ge1xuXHRcdFx0XHRcdHBhcmFtcyA9IHBhcmFtcy5tYXAocGFyYW0gPT4gcGFyYW0gPT09IFwiJHBhbmVsJFwiID8gcGFuZWwgOiBwYXJhbSk7XG5cdFx0XHRcdFx0cGFuZWwuX2RlYnVnKGBDb21tYW5kOiAgJHtuYW1lfSAke3BhcmFtcy5zbGljZSgwLCBwYXJhbXMubGVuZ3RoIC0gMSkuam9pbignICcpfSAgLS0+YCk7XG5cdFx0XHRcdFx0bGV0IG91dCA9IGF3YWl0IHBhbmVsLmNtZHMuZmluZChjbWQgPT4gY21kLm5hbWUgPT09IG5hbWUpLmJvZHkoLi4ucGFyYW1zKTtcblx0XHRcdFx0XHRwYW5lbC5fZGVidWcoYCAgJHtvdXR9YCk7XG5cdFx0XHRcdFx0cGFyYW1zW3BhcmFtcy5sZW5ndGggLSAxXShvdXQpO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0c29ja2V0Lm9uKFwiY2xpXCIsIGFzeW5jIGNvbW0gPT4gcGFuZWwucmwud3JpdGUoY29tbSArIG9zLkVPTCkpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0c29ja2V0LmRpc2Nvbm5lY3QodHJ1ZSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gYWRtaW47XG5cdH0gLy9zZXR1cFxuXG59IC8vU29ja2V0XG5cbmV4cG9ydCBkZWZhdWx0IFNvY2tldDtcbiJdfQ==