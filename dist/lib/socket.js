"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const fs = tslib_1.__importStar(require("fs-extra"));
const path = tslib_1.__importStar(require("path"));
const os = tslib_1.__importStar(require("os"));
var Socket;
(function (Socket) {
    /**
     * Wrapper for setting up the Socket.
     *
     * @author V. H.
     * @date 2019-05-12
     * @export
     * @param {SocketIO.Server} io
     * @param {Classes.Panel} panel
     * @returns {SocketIO.Namespace}
     */
    function setup(io, panel) {
        let admin = io.of("/admin"), login = false, ladm;
        panel.on("_debug", async (...data) => {
            if (ladm)
                ladm.emit("_debug", ...data);
        });
        panel.serv.on("_debug", async (...data) => {
            if (ladm)
                ladm.emit("_s_debug", ...data);
        });
        panel.stater.on("snap", async (reg) => {
            if (ladm)
                ladm.emit("snap", reg);
        });
        if (panel.refresh) {
            let ends = new Set([
                ".htm",
                ".html",
                ".htmx",
                ".htmlx",
                ".js",
                ".xjs",
                ".css",
                ".cssx"
            ]);
            fs.watch(path.join(panel.serv.opts.serveDir, panel.serv.opts.public), {
                recursive: true
            }, (evt, file) => {
                if (panel.refresh && Array.from(ends.values()).some(end => file.endsWith(end))) {
                    panel._debug("Refreshing...");
                    admin.emit("refresh");
                }
            });
        }
        admin.on("connect", async (socket) => {
            panel._debug(socket.id + " connected.");
            socket.once("disconnecting", async (reason) => {
                panel._debug(socket.id + " disconnecting  " + reason);
                login = false;
            });
            if (!login) {
                socket.join("admin", async (err) => {
                    if (!err) {
                        socket.emit("_debug", panel._debuglog);
                        socket.emit("_s_debug", panel.serv._debuglog);
                        socket.emit("cli", panel._rllog);
                        for (let snap of panel.stater.samples) {
                            socket.emit("snap", snap);
                        }
                        socket.emit("joined", "admin");
                        panel._debug(`${socket.id} is admin.`);
                        login = true;
                        ladm = socket;
                        socket.emit("stat", "arch", os.arch());
                        socket.emit("stat", "cpus", os.cpus().length);
                        socket.emit("stat", "endian", os.endianness());
                        socket.emit("stat", "platform", os.platform());
                        socket.emit("stat", "release", os.release());
                        socket.emit("stat", "type", os.type());
                        socket.emit("stat", "version", process.version);
                        let prev1 = process.cpuUsage();
                        async function tick() {
                            let mem = process.memoryUsage();
                            prev1 = process.cpuUsage(prev1);
                            socket.emit("stat", "freemem", Math.round((os.freemem() / 1024 / 1024 / 1024) * 100) / 100);
                            socket.emit("stat", "totalmem", Math.round((os.totalmem() / 1024 / 1024 / 1024) * 100) / 100);
                            socket.emit("stat", "priority", os.getPriority());
                            socket.emit("stat", "home", os.homedir());
                            socket.emit("stat", "host", os.hostname());
                            socket.emit("stat", "tmp", os.tmpdir());
                            socket.emit("stat", "up", Math.round(os.uptime() / 6) / 10);
                            socket.emit("stat", "pup", Math.round(process.uptime() / 6) / 10);
                            socket.emit("stat", "cpuus", process.cpuUsage().user / 1000); //micro -> milli
                            socket.emit("stat", "cpuusp", prev1.user / 1000);
                            socket.emit("stat", "cpusy", process.cpuUsage().system / 1000);
                            socket.emit("stat", "cpusyp", prev1.system / 1000);
                            socket.emit("stat", "cwd", process.cwd());
                            socket.emit("stat", "rss", Math.round(100 * mem.rss / 1024 / 1024) / 100);
                            socket.emit("stat", "total1", Math.round(100 * mem.heapTotal / 1024 / 1024) / 100);
                            socket.emit("stat", "used1", Math.round(100 * mem.heapUsed / 1024 / 1024) / 100);
                            socket.emit("stat", "ext", Math.round(100 * mem.external / 1024 / 1024) / 100);
                            socket.emit("stat", "title", process.title);
                            socket.emit("stat", "port", process.debugPort);
                            return tick;
                        } //tick
                        setInterval(await tick(), panel.custping);
                    }
                });
                socket.on("error", async (err) => {
                    panel._debug(err);
                });
                socket.on("command", async (name, ...params) => {
                    params = params.map(param => param === "$panel$" ? panel : param);
                    panel._debug(`Command:  ${name} ${params.slice(0, params.length - 1).join(' ')}  -->`);
                    let out = await panel.cmds.find(cmd => cmd.name === name).body(...params);
                    panel._debug(`  ${out}`);
                    params[params.length - 1](out);
                });
                socket.on("cli", async (comm) => panel.rl.write(comm + os.EOL));
            }
            else {
                socket.disconnect(true);
            }
        });
        return admin;
    } //setup
    Socket.setup = setup;
})(Socket = exports.Socket || (exports.Socket = {})); //Socket
exports.default = Socket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3NvY2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUdiLHFEQUErQjtBQUMvQixtREFBNkI7QUFDN0IsK0NBQXlCO0FBRXpCLElBQWMsTUFBTSxDQWdJbkI7QUFoSUQsV0FBYyxNQUFNO0lBRW5COzs7Ozs7Ozs7T0FTRztJQUNILFNBQWdCLEtBQUssQ0FBQyxFQUFtQixFQUFFLEtBQW9CO1FBQzlELElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQzFCLEtBQUssR0FBWSxLQUFLLEVBQ3RCLElBQXFCLENBQUM7UUFFdkIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBVyxFQUFFLEVBQUU7WUFDM0MsSUFBSSxJQUFJO2dCQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBVyxFQUFFLEVBQUU7WUFDaEQsSUFBSSxJQUFJO2dCQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFDLEdBQUcsRUFBQyxFQUFFO1lBQ25DLElBQUksSUFBSTtnQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUNsQixJQUFJLElBQUksR0FBZ0IsSUFBSSxHQUFHLENBQUM7Z0JB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TSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzt3QkFDN0MsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO3dCQUN2QyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUVoRCxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7d0JBRS9CLEtBQUssVUFBVSxJQUFJOzRCQUNsQixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7NEJBQ2hDLEtBQUssR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDOzRCQUVoQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDOzRCQUM1RixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDOzRCQUM5RixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7NEJBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzs0QkFDMUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxR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a0JBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBDbGFzc2VzIGZyb20gJy4vQ2xhc3Nlcyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIG9zIGZyb20gXCJvc1wiO1xuXG5leHBvcnQgbW9kdWxlIFNvY2tldCB7XG5cblx0LyoqXG5cdCAqIFdyYXBwZXIgZm9yIHNldHRpbmcgdXAgdGhlIFNvY2tldC5cblx0ICogXG5cdCAqIEBhdXRob3IgVi4gSC5cblx0ICogQGRhdGUgMjAxOS0wNS0xMlxuXHQgKiBAZXhwb3J0XG5cdCAqIEBwYXJhbSB7U29ja2V0SU8uU2VydmVyfSBpb1xuXHQgKiBAcGFyYW0ge0NsYXNzZXMuUGFuZWx9IHBhbmVsXG5cdCAqIEByZXR1cm5zIHtTb2NrZXRJTy5OYW1lc3BhY2V9XG5cdCAqL1xuXHRleHBvcnQgZnVuY3Rpb24gc2V0dXAoaW86IFNvY2tldElPLlNlcnZlciwgcGFuZWw6IENsYXNzZXMuUGFuZWwpOiBTb2NrZXRJTy5OYW1lc3BhY2Uge1xuXHRcdGxldCBhZG1pbiA9IGlvLm9mKFwiL2FkbWluXCIpLFxuXHRcdFx0bG9naW46IGJvb2xlYW4gPSBmYWxzZSxcblx0XHRcdGxhZG06IFNvY2tldElPLlNvY2tldDtcblxuXHRcdHBhbmVsLm9uKFwiX2RlYnVnXCIsIGFzeW5jICguLi5kYXRhOiBhbnlbXSkgPT4ge1xuXHRcdFx0aWYgKGxhZG0pIGxhZG0uZW1pdChcIl9kZWJ1Z1wiLCAuLi5kYXRhKTtcblx0XHR9KTtcblx0XHRwYW5lbC5zZXJ2Lm9uKFwiX2RlYnVnXCIsIGFzeW5jICguLi5kYXRhOiBhbnlbXSkgPT4ge1xuXHRcdFx0aWYgKGxhZG0pIGxhZG0uZW1pdChcIl9zX2RlYnVnXCIsIC4uLmRhdGEpO1xuXHRcdH0pO1xuXHRcdHBhbmVsLnN0YXRlci5vbihcInNuYXBcIiwgYXN5bmMgcmVnID0+IHtcblx0XHRcdGlmIChsYWRtKSBsYWRtLmVtaXQoXCJzbmFwXCIsIHJlZyk7XG5cdFx0fSk7XG5cdFx0aWYgKHBhbmVsLnJlZnJlc2gpIHtcblx0XHRcdGxldCBlbmRzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoW1xuXHRcdFx0XHRcIi5odG1cIixcblx0XHRcdFx0XCIuaHRtbFwiLFxuXHRcdFx0XHRcIi5odG14XCIsXG5cdFx0XHRcdFwiLmh0bWx4XCIsXG5cdFx0XHRcdFwiLmpzXCIsXG5cdFx0XHRcdFwiLnhqc1wiLFxuXHRcdFx0XHRcIi5jc3NcIixcblx0XHRcdFx0XCIuY3NzeFwiXG5cdFx0XHRdKTtcblxuXHRcdFx0ZnMud2F0Y2gocGF0aC5qb2luKHBhbmVsLnNlcnYub3B0cy5zZXJ2ZURpciwgcGFuZWwuc2Vydi5vcHRzLnB1YmxpYyksIHtcblx0XHRcdFx0cmVjdXJzaXZlOiB0cnVlXG5cdFx0XHR9LCAoZXZ0LCBmaWxlKSA9PiB7XG5cdFx0XHRcdFx0aWYgKHBhbmVsLnJlZnJlc2ggJiYgQXJyYXkuZnJvbShlbmRzLnZhbHVlcygpKS5zb21lKGVuZCA9PiBmaWxlLmVuZHNXaXRoKGVuZCkpKSB7XG5cdFx0XHRcdFx0XHRwYW5lbC5fZGVidWcoXCJSZWZyZXNoaW5nLi4uXCIpO1xuXHRcdFx0XHRcdFx0YWRtaW4uZW1pdChcInJlZnJlc2hcIik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fVxuXHRcdFxuXHRcdGFkbWluLm9uKFwiY29ubmVjdFwiLCBhc3luYyBzb2NrZXQgPT4ge1xuXHRcdFx0cGFuZWwuX2RlYnVnKHNvY2tldC5pZCArIFwiIGNvbm5lY3RlZC5cIik7XG5cdFx0XHRzb2NrZXQub25jZShcImRpc2Nvbm5lY3RpbmdcIiwgYXN5bmMgcmVhc29uID0+IHtcblx0XHRcdFx0cGFuZWwuX2RlYnVnKHNvY2tldC5pZCArIFwiIGRpc2Nvbm5lY3RpbmcgIFwiICsgcmVhc29uKTtcblx0XHRcdFx0bG9naW4gPSBmYWxzZTtcblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAoIWxvZ2luKSB7XG5cdFx0XHRcdHNvY2tldC5qb2luKFwiYWRtaW5cIiwgYXN5bmMgZXJyID0+IHtcblx0XHRcdFx0XHRpZiAoIWVycikge1xuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJfZGVidWdcIiwgcGFuZWwuX2RlYnVnbG9nKTtcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwiX3NfZGVidWdcIiwgcGFuZWwuc2Vydi5fZGVidWdsb2cpO1xuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJjbGlcIiwgcGFuZWwuX3JsbG9nKTtcblx0XHRcdFx0XHRcdGZvciAobGV0IHNuYXAgb2YgcGFuZWwuc3RhdGVyLnNhbXBsZXMpIHtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzbmFwXCIsIHNuYXApO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcImpvaW5lZFwiLCBcImFkbWluXCIpO1xuXHRcdFx0XHRcdFx0cGFuZWwuX2RlYnVnKGAke3NvY2tldC5pZH0gaXMgYWRtaW4uYCk7XG5cdFx0XHRcdFx0XHRsb2dpbiA9IHRydWU7XG5cdFx0XHRcdFx0XHRsYWRtID0gc29ja2V0O1xuXG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJhcmNoXCIsIG9zLmFyY2goKSk7XG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJjcHVzXCIsIG9zLmNwdXMoKS5sZW5ndGgpO1xuXHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiZW5kaWFuXCIsIG9zLmVuZGlhbm5lc3MoKSk7XG5cdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJwbGF0Zm9ybVwiLCBvcy5wbGF0Zm9ybSgpKTtcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInJlbGVhc2VcIiwgb3MucmVsZWFzZSgpKTtcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInR5cGVcIiwgb3MudHlwZSgpKTtcblx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInZlcnNpb25cIiwgcHJvY2Vzcy52ZXJzaW9uKTtcblxuXHRcdFx0XHRcdFx0bGV0IHByZXYxID0gcHJvY2Vzcy5jcHVVc2FnZSgpO1xuXG5cdFx0XHRcdFx0XHRhc3luYyBmdW5jdGlvbiB0aWNrKCkge1xuXHRcdFx0XHRcdFx0XHRsZXQgbWVtID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xuXHRcdFx0XHRcdFx0XHRwcmV2MSA9IHByb2Nlc3MuY3B1VXNhZ2UocHJldjEpO1xuXG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImZyZWVtZW1cIiwgTWF0aC5yb3VuZCgob3MuZnJlZW1lbSgpIC8gMTAyNCAvIDEwMjQgLyAxMDI0KSAqIDEwMCkgLyAxMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ0b3RhbG1lbVwiLCBNYXRoLnJvdW5kKChvcy50b3RhbG1lbSgpIC8gMTAyNCAvIDEwMjQgLyAxMDI0KSAqIDEwMCkgLyAxMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJwcmlvcml0eVwiLCBvcy5nZXRQcmlvcml0eSgpKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiaG9tZVwiLCBvcy5ob21lZGlyKCkpO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJob3N0XCIsIG9zLmhvc3RuYW1lKCkpO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ0bXBcIiwgb3MudG1wZGlyKCkpO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ1cFwiLCBNYXRoLnJvdW5kKG9zLnVwdGltZSgpIC8gNikgLyAxMCk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInB1cFwiLCBNYXRoLnJvdW5kKHByb2Nlc3MudXB0aW1lKCkgLyA2KSAvIDEwKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiY3B1dXNcIiwgcHJvY2Vzcy5jcHVVc2FnZSgpLnVzZXIgLyAxMDAwKTsgIC8vbWljcm8gLT4gbWlsbGlcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiY3B1dXNwXCIsIHByZXYxLnVzZXIgLyAxMDAwKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwiY3B1c3lcIiwgcHJvY2Vzcy5jcHVVc2FnZSgpLnN5c3RlbSAvIDEwMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJjcHVzeXBcIiwgcHJldjEuc3lzdGVtIC8gMTAwMCk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImN3ZFwiLCBwcm9jZXNzLmN3ZCgpKTtcblx0XHRcdFx0XHRcdFx0c29ja2V0LmVtaXQoXCJzdGF0XCIsIFwicnNzXCIsIE1hdGgucm91bmQoMTAwICogbWVtLnJzcyAvIDEwMjQgLyAxMDI0KSAvIDEwMCk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInRvdGFsMVwiLCBNYXRoLnJvdW5kKDEwMCAqIG1lbS5oZWFwVG90YWwgLyAxMDI0IC8gMTAyNCkgLyAxMDApO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJ1c2VkMVwiLCBNYXRoLnJvdW5kKDEwMCAqIG1lbS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KSAvIDEwMCk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcImV4dFwiLCBNYXRoLnJvdW5kKDEwMCAqIG1lbS5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KSAvIDEwMCk7XG5cdFx0XHRcdFx0XHRcdHNvY2tldC5lbWl0KFwic3RhdFwiLCBcInRpdGxlXCIsIHByb2Nlc3MudGl0bGUpO1xuXHRcdFx0XHRcdFx0XHRzb2NrZXQuZW1pdChcInN0YXRcIiwgXCJwb3J0XCIsIHByb2Nlc3MuZGVidWdQb3J0KTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIHRpY2s7XG5cdFx0XHRcdFx0XHR9IC8vdGlja1xuXG5cdFx0XHRcdFx0XHRzZXRJbnRlcnZhbChhd2FpdCB0aWNrKCksIHBhbmVsLmN1c3RwaW5nKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRzb2NrZXQub24oXCJlcnJvclwiLCBhc3luYyBlcnIgPT4ge1xuXHRcdFx0XHRcdHBhbmVsLl9kZWJ1ZyhlcnIpO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0c29ja2V0Lm9uKFwiY29tbWFuZFwiLCBhc3luYyAobmFtZSwgLi4ucGFyYW1zKSA9PiB7XG5cdFx0XHRcdFx0cGFyYW1zID0gcGFyYW1zLm1hcChwYXJhbSA9PiBwYXJhbSA9PT0gXCIkcGFuZWwkXCIgPyBwYW5lbCA6IHBhcmFtKTtcblx0XHRcdFx0XHRwYW5lbC5fZGVidWcoYENvbW1hbmQ6ICAke25hbWV9ICR7cGFyYW1zLnNsaWNlKDAsIHBhcmFtcy5sZW5ndGggLSAxKS5qb2luKCcgJyl9ICAtLT5gKTtcblx0XHRcdFx0XHRsZXQgb3V0ID0gYXdhaXQgcGFuZWwuY21kcy5maW5kKGNtZCA9PiBjbWQubmFtZSA9PT0gbmFtZSkuYm9keSguLi5wYXJhbXMpO1xuXHRcdFx0XHRcdHBhbmVsLl9kZWJ1ZyhgICAke291dH1gKTtcblx0XHRcdFx0XHRwYXJhbXNbcGFyYW1zLmxlbmd0aCAtIDFdKG91dCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRzb2NrZXQub24oXCJjbGlcIiwgYXN5bmMgY29tbSA9PiBwYW5lbC5ybC53cml0ZShjb21tICsgb3MuRU9MKSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRzb2NrZXQuZGlzY29ubmVjdCh0cnVlKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHJldHVybiBhZG1pbjtcblx0fSAvL3NldHVwXG5cbn0gLy9Tb2NrZXRcblxuZXhwb3J0IGRlZmF1bHQgU29ja2V0O1xuIl19